{% extends "base.html" %}
{#
  templates/borrows.html

  Hiển thị lịch sử mượn của người dùng hiện tại.
  - `records` là danh sách Borrow objects (hoặc với snapshot `book_title`).
  - Nếu borrow chưa trả, hiển thị form POST để gọi route trả sách (book_bp.return_book).
#}
{% block content %}

<h3 class="text-center text-primary mb-4">Lịch sử mượn sách</h3>

{% if records %}
<table class="table table-striped table-bordered align-middle">
  <thead class="table-primary text-center">
    <tr>
      <th>Tên sách</th>
      <th>Ngày mượn</th>
      <th>Ngày trả</th>
    </tr>
  </thead>
  <tbody>
    {% for r in records %}
    <tr class="text-center">
      <td>{{ r.book_title if r.book_title else (r.book.title if r.book else "Đã xóa") }}</td>
      <td>{{ r.borrow_date.strftime("%d/%m/%Y %H:%M") }}</td>
      <td>
        {% if r.return_date %}
          {{ r.return_date.strftime("%d/%m/%Y %H:%M") }}
        {% else %}
          {% if r.return_requested %}
            <span class="text-warning">Yêu cầu trả sách đã gửi ({{ r.return_requested_at.strftime('%d/%m/%Y %H:%M') if r.return_requested_at }})</span>
            <form method="POST" action="{{ url_for('book_bp.cancel_return_request', borrow_id=r.id) }}" class="d-inline ms-2" onsubmit="return confirm('Hủy yêu cầu trả sách?');">
              <button class="btn btn-sm btn-outline-secondary" type="submit">Hủy yêu cầu</button>
            </form>
          {% else %}
            Chưa trả
            <form method="POST" action="{{ url_for('book_bp.return_book', borrow_id=r.id) }}" class="d-inline ms-2" onsubmit="return confirm('Gửi yêu cầu trả sách? Bạn sẽ cần đến thủ thư để hoàn tất.');">
              <button class="btn btn-sm btn-outline-primary" type="submit">Yêu cầu trả sách</button>
            </form>
          {% endif %}
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-center text-muted">Bạn chưa mượn sách nào.</p>
{% endif %}

{% endblock %}
