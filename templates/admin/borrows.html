{% extends "admin/base.html" %}
{#
  templates/admin/borrows.html

  Trang quản trị hiển thị lịch sử mượn toàn hệ thống với filter theo user/book/status
  Admin có thể đánh dấu trả sách hoặc xóa bản ghi lịch sử.
#}
{% block content %}
<h2 class="mb-4">Lịch sử mượn sách</h2>

<div class="card shadow">
  <div class="card-body">
    <!-- Filter form -->
    <form method="GET" class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text">Người dùng</span>
          <input type="text" name="user" class="form-control" placeholder="Tên người dùng..."
                 value="{{ request.args.get('user', '') }}">
        </div>
      </div>
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text">Sách</span>
          <input type="text" name="book" class="form-control" placeholder="Tên sách..."
                 value="{{ request.args.get('book', '') }}">
        </div>
      </div>
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text">Trạng thái</span>
          <select name="status" class="form-select">
            <option value="">Tất cả</option>
            <option value="borrowing" {% if request.args.get('status') == 'borrowing' %}selected{% endif %}>
              Đang mượn
            </option>
            <option value="returned" {% if request.args.get('status') == 'returned' %}selected{% endif %}>
              Đã trả
            </option>
          </select>
          <button type="submit" class="btn btn-primary">Lọc</button>
          <a href="{{ url_for('admin_bp.borrows') }}" class="btn btn-outline-secondary">Reset</a>
        </div>
      </div>
    </form>

    <!-- Borrows table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Người mượn</th>
            <th>Sách</th>
            <th>Ngày mượn</th>
            <th>Ngày trả</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          {% for borrow in borrows.items %}
          <tr>
            <td>{{ borrow.id }}</td>
            <td>{{ borrow.user.username }}</td>
            <td>{{ borrow.book.title if borrow.book else borrow.book_title }}</td>
            <td>{{ borrow.borrow_date.strftime("%d/%m/%Y %H:%M") }}</td>
            <td>
              {% if borrow.return_date %}
              {{ borrow.return_date.strftime("%d/%m/%Y %H:%M") }}
              {% else %}
              —
              {% endif %}
            </td>
            <td>
              {% if borrow.return_date %}
                <span class="badge bg-success">Đã trả</span>
              {% elif borrow.return_requested %}
                <span class="badge bg-info text-dark">Yêu cầu trả</span>
              {% else %}
                <span class="badge bg-warning text-dark">Đang mượn</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group">
                {% if not borrow.return_date %}
                <form method="POST" action="{{ url_for('admin_bp.return_book', borrow_id=borrow.id) }}"
                      style="display: inline-block;"
                      onsubmit="return confirm('Xác nhận đánh dấu sách này đã được trả?')">
                  <button type="submit" class="btn btn-sm btn-success">
                    <i class="bi bi-check-circle"></i> Đánh dấu đã trả
                  </button>
                </form>
                {% endif %}
                <form method="POST" action="{{ url_for('admin_bp.delete_borrow', borrow_id=borrow.id) }}"
                      style="display: inline-block;"
                      onsubmit="return confirm('Xác nhận xóa lịch sử mượn này?')">
                  <button type="submit" class="btn btn-sm btn-danger ms-1">
                    <i class="bi bi-trash"></i> Xóa
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" class="text-center">Không có lịch sử mượn sách nào.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if borrows.pages > 1 %}
    <nav class="mt-3">
      <ul class="pagination justify-content-center">
        {% if borrows.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('admin_bp.borrows', page=borrows.prev_num) }}">Trước</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Trước</span>
        </li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Trang {{ borrows.page }} / {{ borrows.pages }}</span>
        </li>

        {% if borrows.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('admin_bp.borrows', page=borrows.next_num) }}">Sau</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Sau</span>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>
{% endblock %}