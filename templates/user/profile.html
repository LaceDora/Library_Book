{% extends "user/base.html" %}
{#
templates/profile.html

Trang thông tin cá nhân: cho phép thay đổi thông tin contact, upload avatar và đổi mật khẩu.
- Upload avatar giới hạn định dạng qua `allowed_file` và kích thước 2MB.
- Khi thay đổi mật khẩu yêu cầu nhập mật khẩu hiện tại.
#}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title mb-3 text-center">Thông tin cá nhân</h4>

        <!-- Script for password section toggle -->
        <style>
          .input-with-icon {
            position: relative;
          }

          .input-with-icon .icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 2;
          }

          .input-with-icon .password-toggle {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.375rem 0.75rem;
            color: #6c757d;
            background: none;
            border: none;
            cursor: pointer;
          }

          .input-with-icon .form-control {
            padding-left: 2.5rem;
            padding-right: 2.5rem;
          }
        </style>

        <script>
          function togglePwdSection() {
            var section = document.getElementById('changePwdSection');
            if (section.style.display === 'none' || !section.style.display) {
              section.style.display = 'block';
            } else {
              section.style.display = 'none';
            }
          }

          function togglePassword(inputId, button) {
            var input = document.getElementById(inputId);
            var icon = button.querySelector('i');

            if (input.type === 'password') {
              input.type = 'text';
              icon.classList.remove('bi-eye-fill');
              icon.classList.add('bi-eye-slash-fill');
            } else {
              input.type = 'password';
              icon.classList.remove('bi-eye-slash-fill');
              icon.classList.add('bi-eye-fill');
            }
          }
        </script>

        <form method="post" enctype="multipart/form-data" onsubmit="disableProfileSubmit(this)">
          <div class="mb-3 text-center">
            {% if user.avatar_url %}
            <img src="{{ user.avatar_url }}" alt="avatar" class="rounded-circle" width="96" height="96">
            {% else %}
            <div class="avatar-placeholder rounded-circle bg-secondary"
              style="width:96px;height:96px;display:inline-block;"></div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">Avatar (jpg/png, tối đa 2MB)</label>
            <input type="file" name="avatar" class="form-control">
          </div>


          <div class="mb-3">
            <label class="form-label">Email</label>
            <div class="input-with-icon">
              <span class="icon"><i class="bi bi-envelope-fill" aria-hidden="true"></i></span>
              <input type="email" name="email" class="form-control" value="{{ user.email or '' }}">
              {% if user.email %}
              <div class="position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); z-index: 10;">
                {% if user.email_verified %}
                <span class="badge bg-success" title="Đã xác thực"><i class="bi bi-check-circle-fill"></i> Đã xác
                  thực</span>
                {% else %}
                <span class="badge bg-warning text-dark" title="Chưa xác thực"><i
                    class="bi bi-exclamation-triangle-fill"></i> Chưa xác thực</span>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Số điện thoại</label>
            <div class="input-with-icon">
              <span class="icon"><i class="bi bi-telephone-fill" aria-hidden="true"></i></span>
              <input type="text" name="phone" class="form-control" value="{{ user.phone or '' }}">
              {% if user.phone %}
              <div class="position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); z-index: 10;">
                {% if user.phone_verified %}
                <span class="badge bg-success" title="Đã xác thực"><i class="bi bi-check-circle-fill"></i> Đã xác
                  thực</span>
                {% else %}
                <span class="badge bg-warning text-dark me-2" title="Chưa xác thực"><i
                    class="bi bi-exclamation-triangle-fill"></i> Chưa xác thực</span>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="startPhoneVerification(this)">Xác
                  thực</button>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Tên</label>
            <div class="input-with-icon">
              <span class="icon"><i class="bi bi-person-circle" aria-hidden="true"></i></span>
              <input type="text" name="username" class="form-control" value="{{ user.username }}" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">MSSV/MSCB</label>
            <div class="input-with-icon">
              <span class="icon"><i class="bi bi-person-badge" aria-hidden="true"></i></span>
              <input type="text" class="form-control" value="{{ user.student_staff_id }}" readonly disabled>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Vai trò</label>
            <div class="input-with-icon">
              <span class="icon"><i class="bi bi-person-badge" aria-hidden="true"></i></span>
              <input type="text" class="form-control"
                value="{% if user.is_admin %}Quản thư{% elif user.role == 'student' %}Sinh viên{% elif user.role == 'lecturer' %}Giảng viên{% elif user.role == 'staff' %}Cán bộ{% else %}Không xác định{% endif %}"
                readonly disabled>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label" style="cursor: pointer; transition: color 0.2s;"
              onmouseover="this.style.color='#0d6efd'" onmouseout="this.style.color=''" onclick="togglePwdSection()">Đổi
              mật khẩu</label>
            <div class="small mt-1"><a href="{{ url_for('auth_bp.forgot_password', from='profile') }}">Quên mật
                khẩu?</a></div>
          </div>

          <div id="changePwdSection" style="display: none;">
            <div class="mb-3">
              <label class="form-label">Mật khẩu hiện tại</label>
              <div class="input-with-icon">
                <span class="icon"><i class="bi bi-lock-fill" aria-hidden="true"></i></span>
                <input type="password" name="current_password" id="current_password" class="form-control">
                <button type="button" class="btn btn-link password-toggle"
                  onclick="togglePassword('current_password', this)">
                  <i class="bi bi-eye-fill"></i>
                </button>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Mật khẩu mới</label>
              <div class="input-with-icon">
                <span class="icon"><i class="bi bi-lock-fill" aria-hidden="true"></i></span>
                <input type="password" name="password" id="new_password" class="form-control">
                <button type="button" class="btn btn-link password-toggle"
                  onclick="togglePassword('new_password', this)">
                  <i class="bi bi-eye-fill"></i>
                </button>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Xác nhận mật khẩu mới</label>
              <div class="input-with-icon">
                <span class="icon"><i class="bi bi-lock-fill" aria-hidden="true"></i></span>
                <input type="password" name="password_confirm" id="confirm_password" class="form-control">
                <button type="button" class="btn btn-link password-toggle"
                  onclick="togglePassword('confirm_password', this)">
                  <i class="bi bi-eye-fill"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between">
            <a href="{{ url_for('main_bp.index') }}" class="btn btn-secondary btn-center">Quay lại</a>
            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
          </div>
        </form>

        <script>
          function disableProfileSubmit(form) {
            const btn = form.querySelector('button[type="submit"]');
            if (btn) {
              btn.disabled = true;
              btn.dataset.origText = btn.innerHTML;
              btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang lưu...';

              // Enable lại nút sau 3 giây để tránh trường hợp form submit lỗi
              setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.origText;
              }, 3000);
            }
            return true;
          }
        </script>
      </div>
    </div>
  </div>
</div>
<!-- Modal Verify Phone -->
<div class="modal fade" id="verifyPhoneModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xác thực số điện thoại</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Mã OTP đã được gửi đến số điện thoại <strong>{{ user.phone }}</strong>.</p>
        <p class="text-muted small">Kiểm tra console server để lấy mã (Mock mode).</p>
        <div class="mb-3">
          <label class="form-label">Nhập mã OTP</label>
          <input type="text" id="phoneOtpInput" class="form-control" placeholder="6 chữ số" maxlength="6">
        </div>
        <div id="verifyMessage" class="alert d-none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-primary" onclick="submitPhoneOtp()">Xác nhận</button>
      </div>
    </div>
  </div>
</div>

<script>
  function startPhoneVerification(btn) {
    // Disable button to prevent double click
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch('{{ url_for("user_bp.send_phone_otp") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
      .then(response => response.json())
      .then(data => {
        btn.disabled = false;
        btn.innerHTML = 'Xác thực';

        if (data.success) {
          // Show modal
          new bootstrap.Modal(document.getElementById('verifyPhoneModal')).show();
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        btn.disabled = false;
        btn.innerHTML = 'Xác thực';
        alert('Có lỗi xảy ra. Vui lòng thử lại.');
        console.error('Error:', error);
      });
  }

  function submitPhoneOtp() {
    const otp = document.getElementById('phoneOtpInput').value;
    const msgDiv = document.getElementById('verifyMessage');

    if (!otp) {
      msgDiv.className = 'alert alert-danger';
      msgDiv.textContent = 'Vui lòng nhập mã OTP.';
      msgDiv.classList.remove('d-none');
      return;
    }

    fetch('{{ url_for("user_bp.confirm_phone_otp") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ otp_code: otp })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          msgDiv.className = 'alert alert-success';
          msgDiv.textContent = data.message;
          msgDiv.classList.remove('d-none');

          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          msgDiv.className = 'alert alert-danger';
          msgDiv.textContent = data.message;
          msgDiv.classList.remove('d-none');
        }
      })
      .catch(error => {
        msgDiv.className = 'alert alert-danger';
        msgDiv.textContent = 'Có lỗi xảy ra.';
        msgDiv.classList.remove('d-none');
      });
  }
</script>
{% endblock %}