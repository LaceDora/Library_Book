@startuml
actor "Thành viên (User)" as User
participant "Giao diện (View)\nBorrowPage" as View
participant "Bộ xử lý (Controller)\nBorrowController" as Controller
database "MySQL Database" as DB

User -> View: Nhấn nút "Mượn sách" (book_id)
View -> Controller: requestBorrow(user_id, book_id)
Controller -> DB: SELECT title, available_quantity FROM book WHERE id = book_id
DB --> Controller: (title, available_quantity)
alt [available_quantity <= 0]
  Controller -> View: Trả về lỗi "Sách đã hết"
else [available_quantity > 0]
  Controller -> DB: START TRANSACTION
  Controller -> DB: INSERT INTO borrow (user_id, book_id, book_title, borrow_date) VALUES (...)
  DB --> Controller: Insert ID: 101
  Controller -> DB: UPDATE book SET available_quantity = available_quantity - 1 WHERE id = book_id
  Controller -> DB: INSERT INTO audit (action='borrow', actor_user_id=..., target_book_id=..., timestamp=NOW())
  Controller -> DB: COMMIT
  Controller -> View: Trả về thành công
  View -> User: Hiển thị "Mượn thành công"
end
@enduml
